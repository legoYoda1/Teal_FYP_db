<!DOCTYPE html>
<html>
<head>
    <title>Historical Report Dashboard</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assist.css') }}">
    <!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

</head>
<body>
    <h1>Historical Report Dashboard - Assisted</h1>
    <div class="top-right">
        <a href="/" class="nav-button">home</a>
    </div>
    <div class="top-left"><img src="static\company_logo.png" id="logo"></div>

    <form method="POST" style="margin-top: 20px;  margin-bottom: 50px;">
         <!-- Time Interval Dropdown -->
    <label for="time_interval">Time Interval:</label>
    <select name="time_interval" id="time_interval" onchange="toggleDateRange(this.value)">
        <option value="">-- All --</option>
        <option value="last_7_days">Last 7 Days</option>
        <option value="last_30_days">Last 30 Days</option>
        <option value="this_month">This Month</option>
        <option value="custom">Custom Range</option>
    </select>

    <!-- Custom Date Range -->
    <div id="date-range-section" style="display: none;">
        <label for="start_date">Start Date:</label>
        <input type="date" name="start_date" id="start_date">

        <label for="end_date">End Date:</label>
        <input type="date" name="end_date" id="end_date">
    </div>
    
        <label for="repeated_defect">Repeated Defect:</label>
        <select name="repeated_defect" id="repeated_defect">
            <option value="">-- All --</option>
            <option value="1">Yes</option>
            <option value="0">No</option>
        </select>

        <label for="zone">Zone:</label>
        <select name="zone" id="zone">
            <option value="">-- All --</option>
            <option value="NE">NE</option>
            <option value="NW">NW</option>
            <option value="SE">SE</option>
            <option value="SW">SW</option>
        </select>
    
        <br><br>
        <button type="submit" style="background-color: #e02224;">Filter Reports</button>
    </form>

    <label style="font-size: 1.2em; font-weight: bold;">Saved Queries:</label>
<div id="saved-queries-container"></div>

<button onclick="openQueryModal()" class="edit-button" style="margin: 10px;">➕ Add Query</button>

<!-- Modal -->
<div id="queryModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeQueryModal()">&times;</span>
    <h3>Add New Query</h3>
    <form id="save-query-form">
        <input type="hidden" name="id" id="edit-query-id">
      <input class="modal-input" type="text" name="label" placeholder="Query Label" required><br>
      <textarea class="modal-input" name="sql_query" placeholder="SQL Query" rows="4" required></textarea><br>
      <textarea class="modal-input" name="chart_code" placeholder="Chart Code (Optional)" rows="4"></textarea><br>
      <button type="submit" class="modal-button" onclick="closeQueryModal()">Save Query</button>
    </form>
  </div>
</div>


    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}

    <table id="assist-data-table" class="data-table display" style="width:100%">
        <thead><tr id="assist-table-headers"></tr></thead>
    </table>

    <div id="loader" class="loader-overlay">
  <div class="spinner"></div>
</div>

    <button id="show-charts-btn" onclick="renderChart()" style="margin-bottom: 10px; background-color: #e02224;">Show Charts</button>
    <div class="chart" id="chart-div"></div>

    <!-- Show Charts Button Script -->
     <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
     {% if fig_json %}
<script>
    function renderChart() {
        const figData = JSON.parse('{{ fig_json | safe }}');
        Plotly.newPlot("chart-div", figData.data, figData.layout);
    }
</script>
{% else %}
<script>
        function renderChart() {
            console.warn("No chart data available.");
            const chartDiv = document.getElementById("chart-div");
            chartDiv.innerHTML = "<p>No chart data available.</p>";
        }
</script>
{% endif %}



    <!-- Custom date range toggle script -->
<script>
    function toggleDateRange(value) {
        const dateSection = document.getElementById('date-range-section');
        if (value === 'custom') {
            dateSection.style.display = 'block';
        } else {
            dateSection.style.display = 'none';
        }
    }
</script>   

    <!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function () {
    // Destroy and rebuild table on load
    buildAssistDataTable();

    function buildAssistDataTable() {
        $.ajax({
            url: "/api/assist_query_data",
            type: "POST",
            data: {
                draw: 1,
                start: 0,
                length: 10,
                editable_query: $("input[name='editable_query']").val() || "SELECT * FROM report_fact",
                time_interval: $("#time_interval").val(),
                start_date: $("#start_date").val(),
                end_date: $("#end_date").val(),
                repeated_defect: $("#repeated_defect").val(),
                zone: $("#zone").val()
            },
            success: function (response) {
                if (response.columns && response.columns.length > 0) {
                    // Build headers
                    let headerRow = '';
                    response.columns.forEach(col => {
                        headerRow += `<th>${col}</th>`;
                    });

                    // Reset table structure
                    $('#assist-data-table').empty();
                    $('#assist-data-table').append('<thead><tr id="assist-table-headers"></tr></thead>');
                    $('#assist-table-headers').html(headerRow);

                    // Define columns
                    const columnsDef = response.columns.map(col => ({ data: col }));

                    // Initialize DataTable
                    $('#assist-data-table').DataTable({
                        serverSide: true,
                        processing: true,
                        ajax: {
                            url: "/api/assist_query_data",
                            type: "POST",
                            data: function (d) {
                                d.editable_query = $("input[name='editable_query']").val() || "SELECT * FROM report_fact";
                                d.time_interval = $("#time_interval").val();
                                d.start_date = $("#start_date").val();
                                d.end_date = $("#end_date").val();
                                d.repeated_defect = $("#repeated_defect").val();
                                d.zone = $("#zone").val();
                            }
                        },
                        columns: columnsDef,
                        scrollX: true,
                        pageLength: 10,
                        lengthMenu: [5, 10, 25, 50, 100],
                        fixedHeader: true
                    });
                } else {
                    $('#assist-data-table').html("<p style='color:red;'>No columns returned.</p>");
                }
            },
            error: function () {
                $('#assist-data-table').html("<p style='color:red;'>Failed to load data.</p>");
            }
        });
    }
});
</script>

<!-- Query Modal Script -->
<script>
function openQueryModal() {
    document.getElementById("queryModal").style.display = "block";
}

function closeQueryModal() {
    document.getElementById("queryModal").style.display = "none";
}

window.onclick = function(event) {
    const modal = document.getElementById("queryModal");
    if (event.target === modal) {
        modal.style.display = "none";
    }
}

function openEditorFromDataset(button) {
    const id = button.dataset.id;
    const label = button.dataset.label;
    const sql_query = decodeURIComponent(button.dataset.sql);
    const chart_code = decodeURIComponent(button.dataset.chart);

    // Show modal and prefill fields
    openQueryModal();
    document.querySelector("#edit-query-id").value = id;
    document.querySelector("#save-query-form input[name='label']").value = label;
    document.querySelector("#save-query-form textarea[name='sql_query']").value = sql_query;
    document.querySelector("#save-query-form textarea[name='chart_code']").value = chart_code || '';
}
</script>

<!-- Loader CSS -->
<script>
function showLoader() {
    document.getElementById("loader").style.display = "flex";
}
function hideLoader() {
    document.getElementById("loader").style.display = "none";
}</script>

<!-- query filters script -->
<script>
    document.querySelectorAll(".quick-form").forEach(form => {
        form.addEventListener("submit", function () {
            showLoader();
            form.querySelector("#form_time_interval").value = document.querySelector("#time_interval").value;
            form.querySelector("#form_start_date").value = document.querySelector("#start_date").value;
            form.querySelector("#form_end_date").value = document.querySelector("#end_date").value;
            form.querySelector("#form_repeated_defect").value = document.querySelector("#repeated_defect").value;
            form.querySelector("#form_zone").value = document.querySelector("#zone").value;
            form.querySelector("#form_chart").value = form.querySelector("#chart").value;
        });
    });
</script>

<!-- Save Query Script -->
 <script>
function loadSavedQueries() {
    fetch('/api/saved_queries')
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById("saved-queries-container");
            container.innerHTML = "";
            data.forEach(q => {
                const form = document.createElement("form");
                form.method = "POST";
                form.action = "/assist";
                form.className = "quick-form";
                form.innerHTML = `
                    <input type="hidden" name="editable_query" value="${encodeURIComponent(q.sql_query)}">
                    <input type="hidden" name="time_interval" id="form_time_interval">
                    <input type="hidden" name="start_date" id="form_start_date">
                    <input type="hidden" name="end_date" id="form_end_date">
                    <input type="hidden" name="repeated_defect" id="form_repeated_defect">
                    <input type="hidden" name="zone" id="form_zone">
                    <input type="hidden" name="chart" id="form_chart" value="${q.chart_code}">
                    <button type="submit" class="query-button">${q.label}</button>
                    <button type="button" class="edit-button" data-id="${q.id}" data-label="${q.label}" data-sql="${encodeURIComponent(q.sql_query)}" data-chart="${encodeURIComponent(q.chart_code)}" onclick="openEditorFromDataset(this)">✏️ Edit</button>
                    <button type="button" class="delete-button" style="margin-bottom: 10px" onclick="deleteQuery(${q.id})">Delete</button>
                `;
                container.appendChild(form);
            });
        });
}

function deleteQuery(id) {
    fetch(`/api/saved_queries/${id}`, { method: 'DELETE' })
        .then(() => loadSavedQueries());
}

document.getElementById("save-query-form").addEventListener("submit", function (e) {
    e.preventDefault();
    showLoader();

    const formData = new FormData(e.target);
    const payload = Object.fromEntries(formData.entries());

    // Use PATCH for edit, POST for new
    const isEdit = payload.id && payload.id.trim() !== "";
    const method = isEdit ? "PATCH" : "POST";
    const url = isEdit ? `/api/saved_queries/${payload.id}` : `/api/saved_queries`;

    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    }).then(() => {
        e.target.reset();
        document.querySelector("#edit-query-id").value = ""; // clear hidden id
        loadSavedQueries();
        hideLoader();
    });
});


document.addEventListener("DOMContentLoaded", loadSavedQueries);
</script>

</body>
</html>