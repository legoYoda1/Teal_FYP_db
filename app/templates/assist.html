<!DOCTYPE html>
<html>
<head>
    <title>Historical Report Dashboard</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='landing.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assist.css') }}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
</head>
<body>
    <h1>Historical Report Dashboard</h1>
    <div class="top-right">
        <a href="/" class="nav-button">Home</a>
    </div>
    <div class="top-left">
        <img src="{{ url_for('static', filename='company_logo.png') }}" id="logo">
    </div>

<!-- filters section -->
    <form id="filter-form" style="margin-top: 20px; margin-bottom: 50px;">
        <label for="time_interval">Time Interval:</label>
        <select name="time_interval" id="time_interval" onchange="toggleDateRange(this.value)">
            <option value="">-- All --</option>
            <option value="last_7_days">Last 7 Days</option>
            <option value="last_30_days">Last 30 Days</option>
            <option value="this_month">This Month</option>
            <option value="custom">Custom Range</option>
        </select>

        <div id="date-range-section" style="display: none;">
            <label for="start_date">Start Date:</label>
            <input type="date" name="start_date" id="start_date">

            <label for="end_date">End Date:</label>
            <input type="date" name="end_date" id="end_date">
        </div>

        <label for="repeated_defect">Repeated Defect:</label>
        <select name="repeated_defect" id="repeated_defect">
            <option value="">-- All --</option>
            <option value="1">Yes</option>
            <option value="0">No</option>
        </select>


        <label for="asset_type">Asset:</label>
        <select name="asset_type" id="asset_type">
            <option value="all">-- All --</option>
            <option value="1">flexible pavement</option>
            <option value="2">sign</option>
            <option value="3">road marking</option>
            <option value="4">kerb</option>
            <option value="5">dic kerb</option>
            <option value="6">manhole</option>
            <option value="7">rigid pavement</option>
            <option value="8">railing</option>
            <option value="9">y</option>
            <option value="10">marker post</option>
            <option value="11">semi-rigid pavement</option>
            <option value="12">alu railing</option>
            <option value="13">vig</option>
            <option value="14">divider</option>
            <option value="15">slp</option>
            <option value="16">crash cushion</option>
            <option value="17">street lighting</option>
            <option value="18">dic grating</option>
            <option value="19">grating</option>
            <option value="20">work in progress</option>
            <option value="21">street name sign</option>
            <option value="22">bollard</option>
            <option value="23">guardrail</option>
            <option value="24">others</option>
            <option value="25">convex mirror</option>
            <option value="26">kerb damaged</option>
            <option value="27">road marking faded</option>
        </select>

        <label for="inspector">Inspector:</label>
        <select name="inspector" id="inspector">
            <option value="all">-- All --</option>
            <option value="1">mohd isyamuddin</option>
            <option value="2">hairi</option>
            <option value="3">zulatika</option>
            <option value="4">senthil</option>
            <option value="5">saifuddin</option>
        </select>

        <br><br>
        <button type="submit" style="background-color: #e02224;">Filter Reports</button>
    </form>
    
<!-- chart dashboard section -->
    <div id="stats-summary" class="stats-flex">
    <div class="stat-card fade-in">
        <h3>Total Defects</h3>
        <p><span id="total-defects">0</span></p>
    </div>
    <div class="stat-card fade-in">
        <h3>Most Common Asset</h3>
        <p id="common-defect">--</p>
    </div>
    <div class="stat-card fade-in">
    <h3>Most Hardworking Inspector</h3>
    <p id="hardworking-inspector">--</p>
</div>
</div>

    <div id="charts-container">
    <div class="chart-row">
        <div class="chart half-width" id="pie-chart"></div>
        <div class="chart half-width" id="bar-chart"></div>
    </div>
    <div class="chart-row">
        <div class="chart full-width" id="timeseries-chart"></div>
    </div>
</div>

<!-- filtered reports table section -->
<div class="report-controls" style="margin-top: 10px;">
    <button id="show-reports-btn" style="background-color: #e02224;">Show Reports</button>
    <button id="hide-reports-btn" style="background-color: #e02224; display: none;">Hide Reports</button>
</div>

{% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}

<div id="reports-table-container" style="display: none;">
    <table id="filtered-data-table" class="data-table display" style="width:100%; margin-top: 10px; margin-bottom: 10px;">
        <thead><tr id="filtered-table-headers"></tr></thead>
    </table>
</div>

<!-- spinner section -->
    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
    </div>


<script>
    function toggleDateRange(value) {
        const section = document.getElementById("date-range-section");
        section.style.display = value === "custom" ? "block" : "none";
    }

    function showLoader() {
        document.getElementById("loader").style.display = "flex";
    }
    function hideLoader() {
        document.getElementById("loader").style.display = "none";
    }

    function loadPlotlyCharts() {
        showLoader();
        $.ajax({
            url: "/api/assist_query_data",
            type: "POST",
            data: {
                time_interval: $("#time_interval").val(),
                start_date: $("#start_date").val(),
                end_date: $("#end_date").val(),
                repeated_defect: $("#repeated_defect").val(),
                asset_type: $("#asset_type").val(),
                inspector: $("#inspector").val()
            },
            success: function (response) {
                hideLoader();
                renderPieChart(response.pie_data);
                renderBarChart(response.bar_data);
                renderTimeSeriesChart(response.timeseries_data);
                animateCount("total-defects", response.total_defects);
                $("#common-defect").text(response.most_common_defect || "N/A");
                $("#hardworking-inspector").text(response.hardworking_inspector || "N/A");
            },
            error: function (err) {
                hideLoader();
                alert("Failed to load data.");
            }
        });
    }

    function getDarkLayout(title) {
    return {
        title: { text: title, font: { color: '#ffffff' } },
        paper_bgcolor: '#1e1e2f',
        plot_bgcolor: '#1e1e2f',
        font: { color: '#ffffff' },
        xaxis: { color: '#ffffff' },
        yaxis: { color: '#ffffff', title: 'Report Count' },
        legend: { font: { color: '#ffffff' } }
    };
}

const brandColors = [
    '#1b64ef', // primary blue
    '#00c7b7', // teal
    '#ffb547', // amber
    '#e94f37', // red-orange
    '#a855f7', // purple
    '#2dd36f'  // green
];

function renderPieChart(data) {
    const trace = {
        labels: data.map(d => d.inspector_name),
        values: data.map(d => d.count),
        type: 'pie',
        marker: { colors: brandColors },
        textfont: { color: '#ffffff' }
    };
    Plotly.newPlot('pie-chart', [trace], getDarkLayout('Reports by Inspector'));
}

function renderBarChart(data) {
    const trace = {
        x: data.map(d => d.aname),
        y: data.map(d => d.count),
        type: 'bar',
        marker: { color: brandColors }, // consistent blue bars
    };
    Plotly.newPlot('bar-chart', [trace], getDarkLayout('Top 10 Asset Types'));
}

function renderTimeSeriesChart(data) {
    const traces = [];

    const grouped = {};
    data.forEach(d => {
        if (!grouped[d.aname]) grouped[d.aname] = [];
        grouped[d.aname].push({ date: d.date_key, count: d.count });
    });

    let colorIndex = 0;
    for (const [cause, values] of Object.entries(grouped)) {
        traces.push({
            x: values.map(v => {
    const dateStr = v.date.toString();
    const year = dateStr.substring(0, 4);
    const month = dateStr.substring(4, 6);
    const day = dateStr.substring(6, 8);
    return `${year}-${month}-${day}`; // ISO format YYYY-MM-DD
}),
            y: values.map(v => v.count),
            type: 'scatter',
            mode: 'lines+markers',
            name: cause,
            line: { color: brandColors[colorIndex % brandColors.length] }
        });
        colorIndex++;
    }

    Plotly.newPlot('timeseries-chart', traces, getDarkLayout('Reports Over Time'));
}

let dataTableInstance = null;
    $(document).ready(function () {
    // Load charts immediately on page load
    loadPlotlyCharts();

    // When the filter form is submitted
    $("#filter-form").on("submit", function (e) {
        e.preventDefault(); // Stop page refresh
        showLoader();
        loadPlotlyCharts();
    if ($("#hide-reports-btn").is(":visible")) {
            if (dataTableInstance) {
        dataTableInstance.destroy();  // destroy DataTable instance
        dataTableInstance = null;     // clear the variable to avoid stale reference
        $("#filtered-data-table tbody").empty();
    }
            $("#reports-table-container").hide();
            $("#hide-reports-btn").hide();
            $("#show-reports-btn").show();
    }
});

    // Show/hide reports table functionality    
    $("#show-reports-btn").on("click", function() {
        showLoader();
        $(this).hide();
        $("#hide-reports-btn").show();
        
        // Show the container first
        $("#reports-table-container").show();
        
        // Only initialize if not already initialized
        if (!dataTableInstance) {
            initializeDataTable();
        } else {
            // If already exists, just refresh the data
            dataTableInstance.ajax.reload(null, false);
            hideLoader();
        }
    });
    
    $("#hide-reports-btn").on("click", function() {
        // Hide the container (no need to destroy unless you want to)
        if (dataTableInstance) {
            dataTableInstance.destroy();  // destroy DataTable instance
            dataTableInstance = null;     // clear the variable to avoid stale reference
            $("#filtered-data-table tbody").empty();
        }
        $("#reports-table-container").hide();
        $(this).hide();
        $("#show-reports-btn").show();
    });
});

/* Filtered data table script */
    function initializeDataTable() {
        $.ajax({
            url: "/api/filter_table_data",
            type: "POST",
            data: { draw: 1, start: 0, length: 5 },
            success: function (response) {
                if (response.columns && response.columns.length > 0) {
                    // Inject table headers
                    let headerRow = '';
                    response.columns.forEach(col => {
                        headerRow += `<th>${col}</th>`;
                    });
                    $("#filtered-table-headers").html(headerRow);

                    // Build column definitions
                    let columnsDef = response.columns.map(col => ({ data: col }));

                    // Initialize DataTable with proper cleanup first
                    if ($.fn.DataTable.isDataTable("#filtered-data-table")) {
                        $('#filtered-data-table').DataTable().destroy();
                    }

                    dataTableInstance = $('#filtered-data-table').DataTable({
                        serverSide: true,
                        processing: true,
                        ajax: {
                            url: "/api/filter_table_data",
                            type: "POST"
                        },
                        columns: columnsDef,
                        scrollX: true,
                        pageLength: 5,
                        lengthMenu: [5, 10, 25, 50, 100],
                        fixedHeader: true,
                        initComplete: function() {
                            hideLoader();
                        }
                    });
                } else {
                    $("#filtered-data-table").html("<p style='color:red;'>No columns returned. Check SQL syntax</p>");
                    hideLoader();
                    $("#hide-reports-btn").hide();
                    $("#show-reports-btn").show();
                }
            },
            error: function () {
                $("#filtered-data-table").html("<p style='color:red;'>Failed to load data.</p>");
                hideLoader();
                $("#hide-reports-btn").hide();
                $("#show-reports-btn").show();
            }
        });
    }
</script>

<!-- Report viewing button script -->
<script>
function requestViewerLink(filePath) {
    showLoader();
    fetch('/api/get_viewer_link', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ file_path: filePath })
    })
    .then(response => response.json())
    .then(data => {
        const url = data.url;
        window.open(url, '_blank');
    })
    .catch(err => {
        console.error("Error getting viewer link:", err);
        alert("Failed to fetch link.");
    });
    hideLoader();
}
</script>

<!-- defect count animator script -->
<script>
function animateCount(id, endValue, duration = 1) {
    const el = document.getElementById(id);
    const startValue = 0;
    const range = endValue - startValue;
    let startTime = null;

    function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = timestamp - startTime;
        const percent = Math.min(progress / duration, 1);
        const current = Math.floor(percent * range);
        el.textContent = current.toLocaleString();
        if (percent < 1) {
            window.requestAnimationFrame(step);
        }
    }

    window.requestAnimationFrame(step);
}
</script>
</body>
</html>
