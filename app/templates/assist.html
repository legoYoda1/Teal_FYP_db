<!DOCTYPE html>
<html>
<head>
    <title>Historical Report Dashboard</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='landing.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assist.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>
<body>
    <h1>Historical Report Dashboard</h1>
    <div class="top-right">
        <a href="/" class="nav-button">Home</a>
    </div>
    <div class="top-left">
        <img src="{{ url_for('static', filename='company_logo.png') }}" id="logo">
    </div>

    <form id="filter-form" style="margin-top: 20px; margin-bottom: 50px;">
        <label for="time_interval">Time Interval:</label>
        <select name="time_interval" id="time_interval" onchange="toggleDateRange(this.value)">
            <option value="">-- All --</option>
            <option value="last_7_days">Last 7 Days</option>
            <option value="last_30_days">Last 30 Days</option>
            <option value="this_month">This Month</option>
            <option value="custom">Custom Range</option>
        </select>

        <div id="date-range-section" style="display: none;">
            <label for="start_date">Start Date:</label>
            <input type="date" name="start_date" id="start_date">

            <label for="end_date">End Date:</label>
            <input type="date" name="end_date" id="end_date">
        </div>

        <label for="repeated_defect">Repeated Defect:</label>
        <select name="repeated_defect" id="repeated_defect">
            <option value="">-- All --</option>
            <option value="1">Yes</option>
            <option value="0">No</option>
        </select>

        <label for="zone">Zone:</label>
        <select name="zone" id="zone">
            <option value="">-- All --</option>
            <option value="NE">NE</option>
            <option value="NW">NW</option>
            <option value="SE">SE</option>
            <option value="SW">SW</option>
        </select>

        <br><br>
        <button type="submit" style="background-color: #e02224;">Filter Reports</button>
    </form>
    
    <div id="stats-summary" class="stats-flex">
    <div class="stat-card fade-in">
        <h3>Total Defects</h3>
        <p><span id="total-defects">0</span></p>
    </div>
    <div class="stat-card fade-in">
        <h3>Most Common Defect</h3>
        <p id="common-defect">--</p>
    </div>
    <div class="stat-card fade-in">
    <h3>Defect Hotspot</h3>
    <p id="hotspot">--</p>
</div>
</div>

    <div id="charts-container">
    <div class="chart-row">
        <div class="chart half-width" id="pie-chart"></div>
        <div class="chart half-width" id="bar-chart"></div>
    </div>
    <div class="chart-row">
        <div class="chart full-width" id="timeseries-chart"></div>
    </div>
</div>

    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
    </div>

<script>
    function toggleDateRange(value) {
        const section = document.getElementById("date-range-section");
        section.style.display = value === "custom" ? "block" : "none";
    }

    function showLoader() {
        document.getElementById("loader").style.display = "flex";
    }
    function hideLoader() {
        document.getElementById("loader").style.display = "none";
    }

    function loadPlotlyCharts() {
        showLoader();
        $.ajax({
            url: "/api/assist_query_data",
            type: "POST",
            data: {
                time_interval: $("#time_interval").val(),
                start_date: $("#start_date").val(),
                end_date: $("#end_date").val(),
                repeated_defect: $("#repeated_defect").val(),
                zone: $("#zone").val()
            },
            success: function (response) {
                hideLoader();
                renderPieChart(response.pie_data);
                renderBarChart(response.bar_data);
                renderTimeSeriesChart(response.timeseries_data);
                animateCount("total-defects", response.total_defects);
                $("#common-defect").text(response.most_common_defect || "N/A");
            },
            error: function (err) {
                hideLoader();
                alert("Failed to load data.");
            }
        });
    }

    function getDarkLayout(title) {
    return {
        title: { text: title, font: { color: '#ffffff' } },
        paper_bgcolor: '#1e1e2f',
        plot_bgcolor: '#1e1e2f',
        font: { color: '#ffffff' },
        xaxis: { color: '#ffffff' },
        yaxis: { color: '#ffffff' },
        legend: { font: { color: '#ffffff' } }
    };
}

const brandColors = [
    '#1b64ef', // primary blue
    '#00c7b7', // teal
    '#ffb547', // amber
    '#e94f37', // red-orange
    '#a855f7', // purple
    '#2dd36f'  // green
];

function renderPieChart(data) {
    const trace = {
        labels: data.map(d => d.inspector_name),
        values: data.map(d => d.count),
        type: 'pie',
        marker: { colors: brandColors },
        textfont: { color: '#ffffff' }
    };
    Plotly.newPlot('pie-chart', [trace], getDarkLayout('Reports by Inspector'));
}

function renderBarChart(data) {
    const trace = {
        x: data.map(d => d.cause_of_defect),
        y: data.map(d => d.count),
        type: 'bar',
        marker: { color: brandColors } // consistent blue bars
    };
    Plotly.newPlot('bar-chart', [trace], getDarkLayout('Reports by Cause of Defect'));
}

function renderTimeSeriesChart(data) {
    const traces = [];

    const grouped = {};
    data.forEach(d => {
        if (!grouped[d.cause_of_defect]) grouped[d.cause_of_defect] = [];
        grouped[d.cause_of_defect].push({ date: d.date_key, count: d.count });
    });

    let colorIndex = 0;
    for (const [cause, values] of Object.entries(grouped)) {
        traces.push({
            x: values.map(v => {
    const dateStr = v.date.toString();
    const year = dateStr.substring(0, 4);
    const month = dateStr.substring(4, 6);
    const day = dateStr.substring(6, 8);
    return `${year}-${month}-${day}`; // ISO format YYYY-MM-DD
}),
            y: values.map(v => v.count),
            type: 'scatter',
            mode: 'lines+markers',
            name: cause,
            line: { color: brandColors[colorIndex % brandColors.length] }
        });
        colorIndex++;
    }

    Plotly.newPlot('timeseries-chart', traces, getDarkLayout('Reports Over Time by Cause of Defect'));
}

    $(document).ready(function () {
    // Load charts immediately on page load
    loadPlotlyCharts();

    // When the filter form is submitted
    $("#filter-form").on("submit", function (e) {
        e.preventDefault(); // Stop page refresh
        loadPlotlyCharts(); // Reload charts with filters
    });
});
</script>


<!-- defect count animator script -->
<script>
function animateCount(id, endValue, duration = 1) {
    const el = document.getElementById(id);
    const startValue = 0;
    const range = endValue - startValue;
    let startTime = null;

    function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = timestamp - startTime;
        const percent = Math.min(progress / duration, 1);
        const current = Math.floor(percent * range);
        el.textContent = current.toLocaleString();
        if (percent < 1) {
            window.requestAnimationFrame(step);
        }
    }

    window.requestAnimationFrame(step);
}
</script>
</body>
</html>
